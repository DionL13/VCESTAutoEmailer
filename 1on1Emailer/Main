function onEditHandler(e) { // Uses custom function handle so isn't a simple trigger and can get permission to other sheets

  // Editing variables
  const edited = e.range; // Gets the range of the edited cell, declares as const to be unchangeable.
  let ss = edited.getSheet(); // Accessing edited sheet
  const column = edited.getColumn();
  const row = edited.getRow(); 
  const editedCell = edited.getA1Notation(); // Gets cell reference
  let day = ss.getName().bold(); // Gets day of session from sheet name
  let editDetails = [ss, row, day]; // To be passed into email confirmation helper function

  let timeCellRef = "C" + row; //  Stores the corresponding cell for the requested time
  let timeNotesCell = "D" + row; // Stores timing notes cell to check if timing notes are empty
  let confirmedEmailCell = "J" + row; // Confirmation cell to be altered after email
  let opsNotesCell = "K" + row;
  let startTime = "";
  let endTime = "";
  let sessionTime = "";

  let tutorEmail = ""; // Initializes email before for loop to keep as a global variable
  let firstName = ""; // Initialising first name of tutor
  let studentEmail = ""; 
  let studentFirst = ""; // Initialising first name of student
  let cellRef = "G" + row; // G is column for tutor notes, row is request row
  let sessionDetails = "";

  // Ops fixes cells
  let timingOpsCell = "L" + row;
  let studentEmailOpsCell = "M" + row;
  let tutorEmailOpsCell = "N" + row; 
  let sendEmailCell = "O" + row;

  // Other spredasheets
  let [ssTutor, ssStudent] = getOtherSpreadsheets(); // Need a helper function for this since simple triggers can't request permission

  // TUTOR/STUDENT, TIMING SEARCHING + EMAILING SECTION

  // Checking if tutor has taken 1:1 after student has filled in their request and time with no timings notes
  if (column == 6) {

    // Ideal time check: second condition is accessing sheet, getting the cell and checking it is NOT empty and that time isn't the invisible character
    if (!ss.getRange(timeCellRef).isBlank() && ss.getRange(timeCellRef).getValue() != "⠀" && ss.getRange(timeNotesCell).isBlank()){
      // Time formatting

      startTime = ss.getRange(timeCellRef).getValue(); // Accesses value in time slot cell

      let startHour = startTime.split(":")[0]; // Splits string at : to check hour
      let startMinutes = startTime.split(":")[1] // Stores minutes and AM/PM of start time
      if (startHour != "12"){ // Calculating end time as 1 hour later than start time by adding 1 to first string element. 
        endTime = String(parseInt(startHour) + 1) + ":" + startMinutes; 
      } else if (startTime.substring(0,2) == "12"){ // If start time is 12, sets end time manually since 12+1 != 1
        endTime = "1:" + startMinutes;
      } 
    }

    editedCellRef = "F" + row; // stores edited cell in tutor column

    if (!ss.getRange(editedCellRef).isBlank()) { // If the edited cell is not left blank (to avoid triggering when a tutor is removed)

      // Only setting time logical for when edited cell isn't blank
      if (startTime != "" && endTime != ""){
        sessionTime = startTime + " to " + endTime;

        ss.getRange(timingOpsCell).setValue(sessionTime);
      }

      // TUTOR EMAIL SECTION
      
      const tutorName = edited.getValue(); 
      let tutorEmailSearchCell = "";

      [firstName, tutorEmail, tutorEmailSearchCell] = findTutorEmail(tutorName); // See Helper Functions script for details

      if (tutorEmail != ""){ // Putting cell for where tutor email exists in Ops data into ops section
        ss.getRange(tutorEmailOpsCell).setValue(tutorEmailSearchCell);
      }


      // STUDENT EMAIL SECTION

      let studentCell = "A" + row; // Getting preferred student name from 1:1 sheet
      let studentName = ss.getRange(studentCell).getValue(); 
      let studentEmailSearchCell = "";

      [studentFirst, studentEmail, studentEmailSearchCell] = findStudentEmail(studentName);

      if (studentEmail != ""){ // Putting reference search cell in ops section
        ss.getRange(studentEmailOpsCell).setValue(studentEmailSearchCell);
      }

      // Checking if notes section next to inputted tutor name is blank after 10 seconds of orignal edit
      Utilities.sleep(2 * 1000); // Halting (sleeping) script for 10 seconds

      if (ss.getRange(cellRef).isBlank()) { // .isBlank() returns true if tutor notes is empty, then enters if condition 

        // SENDING EMAIL SECTION

        // Finding subject name 
        let subjectCell = "B" + row;
        let subjectName = ss.getRange(subjectCell).getValue().bold(); // Extracts subject name, converts to bold text using .bold() (stores as html bolded)

        sessionDetails = [studentFirst, firstName, subjectName];

        if (studentEmail != "" && tutorEmail != "" && startTime != "" && endTime != ""){ // Required conditions for an email to be sent
          sessionTime = startTime + " to " + endTime; // Combining session time into 1 string
          sendConfirmationEmail(studentEmail,tutorEmail,sessionTime,sessionDetails,editDetails);

          // Clearing reference search cells from ops section if email sends
          ss.getRange(tutorEmailOpsCell).setValue("");
          ss.getRange(studentEmailOpsCell).setValue("");
          ss.getRange(timingOpsCell).setValue("");  
        } 
        else if (studentEmail == "" || tutorEmail == "" || (startTime == "" && endTime == "")){ // Failsafe: If no emails are found, sets confirmed email cell to Not Confirmed
          let confirmedEmailCell = "J" + row; 
          ss.getRange(confirmedEmailCell).setValue("Not Confirmed");

          // Setting Ops notes message based on which email(s) missing
          if (studentEmail == "" && tutorEmail == ""){
            ss.getRange(opsNotesCell).setValue("Neither email found");
          } 
          else if (tutorEmail == ""){
            ss.getRange(opsNotesCell).setValue("Tutor email not found");
          } 
          else if (studentEmail == ""){
            ss.getRange(opsNotesCell).setValue("Student email not found");
          }
          else if (ss.getRange(timeCellRef).isBlank() || !ss.getRange(timeNotesCell).isBlank() || ss.getRange(timeCellRef).getValue() == "⠀"){ // Timing checks for when time isn't simple

            ss.getRange(confirmedEmailCell).setValue("Not Confirmed");
            if (ss.getRange(timeCellRef).isBlank() || ss.getRange(timeCellRef).getValue() == "⠀"){
              ss.getRange(opsNotesCell).setValue("No time selected");
            } 
            else if (!ss.getRange(timeNotesCell).isBlank()){
              ss.getRange(opsNotesCell).setValue("Timing requirements");
            } 
          }
        } 
      } 
      else if (!ss.getRange(cellRef).isBlank()){ // If tutor notes is not empty after waiting, set confirmed email to Not Confirmed
        ss.getRange(confirmedEmailCell).setValue("Not Confirmed"); // Sets value to not confirmed
        ss.getRange(opsNotesCell).setValue("Tutor notes not empty");
      }
    }  
  }

  // Remove confirmation status and notes whenever a cell is cleared from the row (not from content or Ops notes)
  if (![5,11,12,13,14,15,16].includes(column) && (ss.getRange(editedCell).isBlank() || ss.getRange(editedCell).getValue() == "⠀" || ss.getRange(editedCell).getValue() == "Y") && row > 3){ // row>3 allows for edits to top rows (not requests).  .includes(column) is if the value of column is in the array, returns true.  == "Y" condition allows for manual changes to confirmation status to reset ops fixes colourings
    if (column != 10){ // Doesn't reset confirmation status if confirmation status is what is originally altered
    ss.getRange(confirmedEmailCell).setValue("");
    }
    ss.getRange(opsNotesCell).setValue("");
    ss.getRange(timingOpsCell).setValue("");
    ss.getRange(sendEmailCell).setValue("");
  }  


  // Ops sending emails after three key datapoints are inputted
  if (column == 15 && ss.getRange(sendEmailCell).getValue() == "Y"){ // If edited send cell and value is "Y"
    if (ss.getRange(timingOpsCell).getBackground() == '#ace1af' && ss.getRange(studentEmailOpsCell).getBackground() == '#ace1af' && ss.getRange(tutorEmailOpsCell).getBackground() == '#ace1af'){ // Checking if all necessary data has been provided. If so, all will be correct colour

      // Retrieving student email
      let studentEmailSearchCell = ss.getRange(studentEmailOpsCell).getValue(); // Gets reference cell to search with in Ops Student Data
      studentEmail = ssStudent.getRange(studentEmailSearchCell).getValue(); // Sets student email as the value of the cell where the reference is in Ops Student Data
      
      // Retrieving tutor email
      let tutorEmailSearchCell = ss.getRange(tutorEmailOpsCell).getValue();
      tutorEmail = ssTutor.getRange(tutorEmailSearchCell).getValue();

      // Retrieving session time
      sessionTime = ss.getRange(timingOpsCell).getValue();

      // Session details 
      firstName = ss.getRange("F" + row).getValue().split(" ")[0]; // Accesses first name of tutor from spreadsheet
      studentFirst = ss.getRange("A" + row).getValue().split(" ")[0];
      
      let subjectCell = "B" + row;
      let subjectName = ss.getRange(subjectCell).getValue().bold(); // Extracts subject name, converts to bold text using .bold() (stores as html bolded)

      sessionDetails = [studentFirst, firstName, subjectName];

      sendConfirmationEmail(studentEmail,tutorEmail,sessionTime,sessionDetails,editDetails); // Edit details are already stored when edit is made to change send to Y

      ss.getRange(confirmedEmailCell).setValue("Y");
      ss.getRange(opsNotesCell).setValue("");
      ss.getRange(sendEmailCell).setValue("");

      ss.getRange(timingOpsCell).setValue("");
      ss.getRange(studentEmailOpsCell).setValue("");
      ss.getRange(tutorEmailOpsCell).setValue("");
    }
    else if (ss.getRange(timingOpsCell).getBackground() != '#ace1af' || ss.getRange(studentEmailOpsCell).getBackground() != '#ace1af' || ss.getRange(tutorEmailOpsCell).getBackground() != '#ace1af'){
      ss.getRange(sendEmailCell).setValue("");

      // Flashing the unfilled cell red twice 
      if (ss.getRange(timingOpsCell).getBackground() != '#ace1af'){
        blinkCell(ss,timingOpsCell);
      }
       if (ss.getRange(studentEmailOpsCell).getBackground() != '#ace1af'){
        blinkCell(ss,studentEmailOpsCell);
      }
       if (ss.getRange(tutorEmailOpsCell).getBackground() != '#ace1af'){
        blinkCell(ss,tutorEmailOpsCell);
      }
    }
  }
}



/*
Current fixes needed:

Potential Improvements:
- Dropdown in timing notes for half-hour and 2-hour sessions, checking validity based on time frame provided on each day
- If a student doesn't have anyone who's filled the request, send out a slack call to arms message
- If a stundent doesn't have anyone who's filled the request on the day of their session, send ops a progressive email update of how many of these there are for the day (like the unconfirmed emails), potentially a call to arms email send out if it goes over a certain number
- Way for users to update code to account for different year's sheets. Search for tutor name and other columns, sheet IDs as a single search at the start of program which updates the auto-emailer code internally.
*/
